using System;
using System.Windows.Forms;
using Excel = Microsoft.Office.Interop.Excel;

namespace ExcelExample
{
    public partial class Form1 : Form
    {
        private Excel.Application excelApp;
        private Excel.Workbook workbook;
        private Excel.Worksheet worksheet;

        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            // Создаем новый экземпляр Excel
            excelApp = new Excel.Application();

            // Добавляем новую книгу
            workbook = excelApp.Workbooks.Add();

            // Получаем первый лист книги
            worksheet = workbook.ActiveSheet;
            
            // Задаем заголовки столбцов
            worksheet.Cells[1, 1] = "Страна";
            worksheet.Cells[1, 2] = "Город";
            worksheet.Cells[1, 3] = "Месяц1";
            worksheet.Cells[1, 4] = "Месяц2";
            worksheet.Cells[1, 5] = "Месяц3";
            worksheet.Cells[1, 6] = "Средняя температура";

            // Выравнивание заголовков по центру
            var range = worksheet.Range["A1:F1"];
            range.HorizontalAlignment = Excel.XlHAlign.xlHAlignCenter;

            // Автоширина столбцов
            worksheet.Columns.AutoFit();
        }

        private void AddCityButton_Click(object sender, EventArgs e)
        {
            string country = CountryTextBox.Text;
            string city = CityTextBox.Text;

            int startRow = 2; // начальная строка для добавления нового города

            // Находим последнюю заполненную строку в столбце "Город"
            while (worksheet.Cells[startRow, 2].Value != null)
            {
                startRow++;
            }

            // Вставляем новый город и его данные в соответствующие столбцы
            worksheet.Cells[startRow, 1] = country;
            worksheet.Cells[startRow, 2] = city;

            int monthCount = int.Parse(MonthCountTextBox.Text);

            for (int i = 0; i < monthCount; i++)
            {
                string monthName = (i + 1).ToString();
                int temperature = int.Parse(MonthTemperatureTextBox.Text);

                worksheet.Cells[startRow, 3 + i] = monthName;
                worksheet.Cells[startRow, 3 + i].Offset[0, 1] = temperature;
            }

            // Вычисляем среднюю температуру
            worksheet.Cells[startRow, 3 + monthCount].FormulaR1C1 = $"=AVERAGE(RC[-{monthCount}]:RC[-1])";

            // Автоширина столбцов
            worksheet.Columns.AutoFit();

            // Очищаем поля ввода
            CountryTextBox.Text = "";
            CityTextBox.Text = "";
            MonthCountTextBox.Text = "";
            MonthTemperatureTextBox.Text = "";
        }

        private void SaveButton_Click(object sender, EventArgs e)
        {
            SaveFileDialog saveFileDialog = new SaveFileDialog();
            saveFileDialog.Filter = "Excel Files|*.xlsx";
            saveFileDialog.Title = "Save an Excel File";
            saveFileDialog.ShowDialog();

            if (saveFileDialog.FileName != "")
            {
                // Сохраняем файл
                workbook.SaveAs(saveFileDialog.FileName);
                workbook.Close();
                excelApp.Quit();
                excelApp = null;
                workbook = null;
                worksheet = null;
                MessageBox.Show("Файл успешно сохранен!");
            }
        }

        private void Form1_FormClosing(object sender, FormClosingEventArgs e)
        {
            // Закрываем приложение Excel при закрытии формы
            if (excelApp != null)
            {
                workbook.Close();
                excelApp.Quit();
            }
        }
    }
}
